
# ü¶Ö C√ìDICE DOMINION v3.1.5 [ADN DEL PROYECTO]

> "En la era de la saturaci√≥n digital, la velocidad es la moneda y la inteligencia es el arma. Dominion no es un bot; es la herramienta para no perder ventas en WhatsApp."

---

## üìú EL CREDO DEL OPERADOR (THE OATH)

1.  **No somos Spammers. Somos Vendedores.** Nuestra tecnolog√≠a es para cerrar ventas, no para molestar gente.
2.  **Human in the Loop.** La IA califica, el Humano cierra. Respetamos ese l√≠mite.
3.  **Privacidad Sagrada (BYOK).** Tus datos son tu activo. Nosotros solo proveemos el motor.
4.  **Verdad Absoluta.** No simulamos datos en el frontend. Todo es persistente y real desde el servidor.
5.  **Tecnolog√≠a con Prop√≥sito.** Cada feature existe para vender m√°s, sin relleno.
6.  **Responsabilidad Operativa.** El sistema sabe cu√°ndo callar. Si el mando falla, el sistema hiberna.

---

## üëÅÔ∏è VISI√ìN & FILOSOF√çA

Este documento detalla la tesis fundamental que impulsa el desarrollo y la estrategia de Dominion.

### 1. La Tesis del "Signal" (Teor√≠a de Se√±ales)
El mercado moderno no sufre de falta de demanda, sufre de **exceso de ruido**. Un mensaje de un cliente potencial en WhatsApp no es simplemente texto; es una **se√±al de intenci√≥n** con una vida √∫til extremadamente corta.

- **La Ventana Cr√≠tica:** La probabilidad de calificar un lead se desploma despu√©s de los primeros 5 minutos. Una se√±al "caliente" (un cliente listo para comprar) se enfr√≠a r√°pidamente si no se act√∫a de inmediato.
- **Misi√≥n de Dominion:** Existir como una infraestructura dise√±ada para **capturar, decodificar y capitalizar** esa se√±al de intenci√≥n en tiempo real, 24/7. No es un "chatbot", es un motor de procesamiento de se√±ales comerciales.

### 2. El Paradigma "Human-in-the-Loop"
La automatizaci√≥n total en ventas de alto valor es una falacia. La IA es una herramienta de apalancamiento, no un reemplazo para el juicio humano y la conexi√≥n personal.

- **La IA Califica, el Humano Cierra:** El rol de Dominion es manejar el 80% del trabajo de bajo valor: responder preguntas frecuentes, filtrar curiosos y medir la "temperatura" de un lead.
- **Protocolo de Escalada:** Una vez que una se√±al es calificada como "Caliente", el sistema entra en "Shadow Mode", silenciando la IA y alertando al vendedor humano. Provee sugerencias de respuesta ("Copiloto") pero cede el control para el cierre final. El humano siempre est√° al mando en la fase cr√≠tica.

### 3. Soberan√≠a de Datos y Costos (BYOK)
La inteligencia comercial y los datos de clientes son los activos m√°s valiosos de una empresa. No deben ser cedidos a terceros.

- **Bring Your Own Key (BYOK):** Dominion se integra con la API Key de Google Gemini del propio cliente. Esto garantiza tres cosas:
    1.  **Privacidad Absoluta:** Las conversaciones no se usan para entrenar nuestros modelos. Lo que pasa en tu negocio, se queda en tu negocio.
    2.  **Control de Costos:** El cliente tiene control total sobre su gasto en IA, aprovechando las capas gratuitas y los precios directos de Google.
    3.  **Transparencia:** No hay "cajas negras". El cliente sabe exactamente qu√© tecnolog√≠a est√° potenciando su operaci√≥n.

### 4. Mercado Objetivo: Calidad sobre Cantidad
Dominion no est√° dise√±ado para spam o marketing masivo. Est√° optimizado para operaciones donde cada conversaci√≥n importa y el costo de un lead perdido es alto.

- **Perfil Ideal:** Agencias, consultores, servicios de alto ticket, inmobiliarias, y cualquier negocio que dependa de la venta consultiva.
- **M√©trica Clave:** No medimos el √©xito por "mensajes enviados", sino por "leads calientes entregados al equipo de ventas".

---

## ü¶æ DOMINION ELITE++: SISTEMA DE ENTRENAMIENTO COMERCIAL

> "No se prueba en producci√≥n. Se entrena en el simulador."

La versi√≥n Elite++ introduce un cambio de paradigma: el Simulador no es solo para verificar que el bot funcione, es para **estresar el cerebro comercial** antes de exponerlo a clientes reales.

### 1. Laboratorio de Simulaci√≥n (Simulation Lab)
Un entorno aislado donde el "Cerebro Neural" (la configuraci√≥n del bot) se enfrenta a escenarios predefinidos dise√±ados para hacerlo fallar.

### 2. Escenarios Adversariales
En lugar de un chat gen√©rico, sometemos al bot a perfiles psicol√≥gicos espec√≠ficos:
- **Objeci√≥n de Precio:** El cliente presiona agresivamente por descuentos. El bot debe defender el valor sin ceder.
- **Cliente Confundido:** Preguntas fuera de contexto. El bot debe re-enrumbar la conversaci√≥n sin alucinar.
- **Riesgo de Ghosting:** Respuestas monos√≠labas. El bot debe intentar re-enganchar.

### 3. Evaluador Pasivo & Memoria de Fallos
El sistema analiza el resultado de cada simulaci√≥n y genera un **Evaluation Result**.
- **Score de Robustez:** Una m√©trica del 0 al 100 que indica qu√© tan bien se desempe√±√≥ el cerebro en ese escenario.
- **Failure Patterns:** El sistema recuerda *c√≥mo* fall√≥ el bot (ej: "Colapso por Fricci√≥n de Precio"). Esto permite al usuario ajustar sus prompts espec√≠ficamente para cubrir esas debilidades.

---

## üì° RADAR DE OPORTUNIDADES 3.0 (SIGNAL DISCOVERY LAYER)

> "La mejor venta es la que ganas antes de que otros sepan que existe."

El Radar transforma Dominion de una herramienta reactiva (esperar mensajes) a un sistema proactivo de inteligencia comercial.

### 1. Filosof√≠a: Escucha Pasiva Inteligente
A diferencia del bot conversacional, el Radar opera en **silencio absoluto**. Escanea grupos de WhatsApp donde el usuario ya participa, buscando se√±ales de intenci√≥n de compra (ej: "Alguien conoce una buena agencia?", "Busco alquiler en zona centro").

### 2. Signal Engine & Scoring
No es un simple buscador de palabras clave. Utilizamos un motor de inferencia dedicado que analiza:
- **Contexto:** ¬øEs una pregunta o una oferta?
- **Urgencia:** ¬øNecesita soluci√≥n inmediata?
- **Intenci√≥n:** Clasificamos en *B√∫squeda Activa*, *Comparaci√≥n* o *Exploraci√≥n*.

Cada se√±al recibe un **Opportunity Score (0-100)**. Solo las se√±ales de alto valor (Score > 50) se notifican al usuario.

### 3. Safety Layer (Protecci√≥n de Marca)
- **Cero Spam:** El Radar JAM√ÅS env√≠a mensajes autom√°ticos. Su √∫nica funci√≥n es alertar al humano.
- **Filtro de Ruido:** Ignora mensajes del propio usuario y descarta conversaciones irrelevantes para proteger la cuota de IA.

---

## üîÆ RADAR 4.0: PREDICTIVE ADVANTAGE ENGINE

> "Radar 4.0 no detecta intenci√≥n. Detecta el momento exacto donde la intenci√≥n va a nacer."

Esta evoluci√≥n convierte al sistema de un "detector" a un "motor predictivo de mercado".

### 1. Market Context Engine
Analiza el contexto colectivo del grupo, no solo mensajes aislados.
- **Momentum:** Detecta si la actividad del grupo est√° acelerando (Hot) o enfri√°ndose (Cooling).
- **Sentimiento Colectivo:** Mide la tensi√≥n o positividad general del grupo antes de sugerir una intervenci√≥n.

### 2. Ventana Predictiva (The Window)
Cada oportunidad viene con una predicci√≥n temporal:
- **Confidence Score:** Probabilidad de que la oportunidad sea real.
- **Urgency Level:** (CRITICAL / HIGH / MEDIUM / LOW).
- **Action Intelligence:** Recomendaci√≥n estrat√©gica sobre C√ìMO y CU√ÅNDO entrar (ej: "Entrada Directa", "Esperar 10 mins").

### 3. Se√±ales Invisibles (Hidden Signals)
La IA busca patrones subyacentes que un humano podr√≠a perder:
- **Micro-lenguaje:** Cambios sutiles en la forma de preguntar.
- **Patrones de Silencio:** Pausas estrat√©gicas despu√©s de una oferta.
- **Convergencia:** Cuando varios usuarios empiezan a hablar de lo mismo.

---

## üåê DOMINION NETWORK: RED COLABORATIVA (v3.1)

> "Transforma leads descartados en capital reputacional."

La Red Dominion permite a los nodos (clientes) interactuar entre s√≠ para intercambiar valor, creando una econom√≠a circular de oportunidades.

### 1. Econom√≠a de Se√±ales
Cuando un bot detecta un lead "CALIENTE" que no encaja con su oferta (ej: una agencia de marketing recibe una consulta sobre desarrollo de software), puede compartir esa **Se√±al de Intenci√≥n** con la red.

### 2. Protocolo de Permiso Estricto
Dominion Network opera bajo un est√°ndar √©tico absoluto:
1.  **Contribuci√≥n:** El nodo A comparte la se√±al (anonimizada).
2.  **Match:** El nodo B (que busca esa categor√≠a) recibe la oportunidad.
3.  **Solicitud:** El sistema, a trav√©s de un **n√∫mero neutral de la red Dominion**, env√≠a un mensaje transparente al prospecto: *"Detectamos tu inter√©s en X. ¬øAceptas ser contactado por un experto certificado de la red?"*
4.  **Conexi√≥n:** Solo si el prospecto dice **S√ç**, se revelan los datos de contacto al nodo B.

---

## üß† CAPABILITY DEPTH ENGINE (ARQUITECTURA DE PROFUNDIDAD COGNITIVA)

Esta capa arquitect√≥nica introduce un sistema de razonamiento param√©trico controlado centralmente. En lugar de activar/desactivar funciones, ajustamos la "profundidad de pensamiento" de la IA.

### 1. Concepto: Depth Level (Nivel de Profundidad)
Un valor entero (1-10) que determina la complejidad computacional y estrat√©gica asignada a un cliente.
- **Nivel 1 (B√°sico):** Respuestas r√°pidas, memoria corta (10 msgs), an√°lisis literal.
- **Nivel 5 (Est√°ndar):** Memoria media (20 msgs), detecci√≥n de tendencias, an√°lisis de sentimiento.
- **Nivel 10 (Deep Strategic):** Memoria extendida (30+ msgs), m√∫ltiples pases de inferencia, predicci√≥n de mercado, an√°lisis de se√±ales ocultas.

### 2. Capability Context
El sistema resuelve din√°micamente un contexto de capacidades para cada interacci√≥n:
`DepthEngine.resolve(level) -> { memoryDepth, inferencePasses, confidenceThreshold, ... }`

Esto permite:
- **Control de Calidad:** Asegurar que los clientes de alto valor reciban el mejor an√°lisis.
- **Escalabilidad:** Gestionar la carga computacional y de API.
- **Monetizaci√≥n Futura:** Vender "Boosts de Inteligencia" temporales para lanzamientos o eventos cr√≠ticos.

### 3. Depth Boosts
Capacidad de inyectar temporalmente un aumento de nivel (+N) a una cuenta espec√≠fica. √ötil para demostraciones de poder o gesti√≥n de crisis.

---

## üí∞ MODELO SAAS Y ESTRATEGIA COMERCIAL

Este documento detalla el modelo de negocio y la estructura de planes.

### 1. Modelo de Negocio: SaaS Multi-Tenant
Dominion opera como una plataforma de Software como Servicio (SaaS) donde m√∫ltiples clientes (inquilinos o *tenants*) utilizan la misma infraestructura de software, pero con sus datos completamente aislados y seguros.

- **Infraestructura Centralizada:** Un √∫nico backend y base de datos sirven a todos los clientes.
- **Aislamiento de Datos:** Cada pieza de informaci√≥n (usuarios, conversaciones, configuraciones) est√° estrictamente vinculada a un `userId`.

### 2. Estrategia de Precios por Profundidad (Tiered Pricing)
La oferta comercial de Dominion est√° directamente ligada a la potencia del **Depth Engine**. Los clientes eligen el nivel de profundidad cognitiva que necesitan, pagando solo por la capacidad de razonamiento que utilizan.

#### a) NIVEL 3: STANDARD (Protocolo Base) - **USD 19/mes**
- **Nivel de Profundidad Asignado:** 3
- **Funcionalidades:** `intent_detection`, `lead_scoring` b√°sico, `auto_reply`.
- **Caso de Uso:** Ideal para negocios con alto volumen de consultas y que necesitan un filtrado r√°pido y eficiente. Automatiza respuestas frecuentes y califica leads con intenci√≥n de compra expl√≠cita.
- **Filosof√≠a:** El punto de entrada para automatizar tu WhatsApp y dejar de perder ventas por demoras.

#### b) NIVEL 7: SNIPER (Modo Estratega) - **USD 39/mes**
- **Nivel de Profundidad Asignado:** 7
- **Funcionalidades Totales:** Incluye todo lo del plan Standard m√°s `close_assist` (Copiloto), `force_run`, y acceso al **Radar 4.0**.
- **Capacidades Aumentadas:** Memoria contextual extendida, an√°lisis de sentimiento, detecci√≥n de micro-lenguaje y manejo de objeciones complejas.
- **Caso de Uso:** Esencial para ventas consultivas, servicios de alto valor (High-Ticket) y cualquier negocio donde entender el matiz de la conversaci√≥n es cr√≠tico para la venta.
- **Filosof√≠a:** La experiencia Dominion completa. No solo responde, sino que entiende, razona y asiste estrat√©gicamente al vendedor humano.

#### c) NIVEL 10: NEURO-BOOST (Inyecci√≥n de Potencia) - **USD 5/48hs**
- **Nivel de Profundidad Asignado:** 10 (Temporal)
- **Funcionalidad:** Un "boost" temporal que eleva la cuenta a la m√°xima capacidad cognitiva.
- **Capacidades M√°ximas:** M√∫ltiples pases de inferencia (Chain-of-Thought), predicci√≥n de tendencias de mercado en grupos y an√°lisis de se√±ales ocultas.
- **Caso de Uso:** Dise√±ado para per√≠odos cr√≠ticos de alta intensidad comercial, como lanzamientos de productos, eventos o campa√±as de marketing agresivas.
- **Filosof√≠a:** Potencia de c√≥mputo bajo demanda para momentos en los que no se puede dejar pasar ni una sola oportunidad.

### 3. Ciclo de Vida de la Suscripci√≥n
1.  **Registro (`trial`):**
    - Al registrarse, un nuevo cliente comienza autom√°ticamente en un per√≠odo de prueba (`plan_status: 'trial'`).
    - **Protocolo de Escasez:** Este per√≠odo otorga acceso a todas las funcionalidades del nivel **Sniper (Nivel 7)** durante **7 d√≠as o hasta calificar 10 conversaciones**, lo que ocurra primero.
2.  **Activaci√≥n (`active`):**
    - Un `super_admin` activa manually la licencia para un plan espec√≠fico.
    - La activaci√≥n cambia el `plan_status` a `active` y establece una nueva `billing_end_date`.
3.  **Expiraci√≥n (`expired`):**
    - Si llega la `billing_end_date` y el plan no se ha renovado, el `plan_status` cambia a `expired`.
    - Las funcionalidades se limitan a un estado `fallback` (respuestas b√°sicas) para no interrumpir el servicio, pero se pierde toda la inteligencia avanzada.

### 4. L√≥gica de Monetizaci√≥n y M√©tricas
- **MRR (Ingreso Mensual Recurrente):** El panel de `super_admin` calcula el MRR sumando el precio del plan de cada cliente con `plan_status: 'active'`.
- **ROIE (Retorno de Inversi√≥n Estimado):** En el dashboard del cliente, se muestra un "Retorno Estimado" calculado como `(N¬∫ de Leads Calientes) x (Valor Fijo por Lead)`.

### 5. Estrategia de Lanzamiento: Precio Fundadores (Early Adopter)
Para recompensar a los primeros usuarios y construir una base de clientes leal, se establece una pol√≠tica de "Precio Fundadores".

- **Definici√≥n:** Todo usuario que se suscriba durante la etapa de lanzamiento del producto es marcado como `is_founder`.
- **Beneficio Principal:** El usuario fundador mantiene el precio de su plan **de forma indefinida**, siempre y cuando su suscripci√≥n permanezca activa e ininterrumpida.
- **Condici√≥n de P√©rdida:** Si el usuario cancela su suscripci√≥n o esta vence por falta de pago, pierde irrevocablemente el beneficio de "Precio Fundadores". Cualquier reactivaci√≥n futura se realizar√° al precio de lista vigente en ese momento.
- **Objetivo:** Incentivar la adopci√≥n temprana, reducir la tasa de cancelaci√≥n (churn) y preparar el terreno para futuras actualizaciones de precios sin afectar a la base de usuarios original.

---

## üèóÔ∏è ARQUITECTURA Y FLUJO DE DATOS

### 1. Diagrama de Arquitectura de Alto Nivel
```
            +----------------+      +------------------+      +-------------------+
            | Cliente (React)|<---->|  Backend (Node)  |<---->|   MongoDB Atlas   |
            +----------------+      +------------------+      +-------------------+
                  ^       |                    |                        ^
                  |       | (API RESTful)      | (Baileys WS)           | (Auth State/Seeds)
                  |       |                    v                        |
                  |       +-----------+----------------+      +-------------------+
                  |                   |  Motor WhatsApp  |      | Google Gemini API |
                  |                   +----------------+      +-------------------+
                  |                           ^                         ^
                  |                           | (Protocolo Web)         | (API RESTful)
                  |                           v                         |
            +----------------+      +------------------+      +-------------------+
            |  Usuario Final |<---->|  WhatsApp Web    |<-----|  (Procesamiento IA) |
            +----------------+      +------------------+      +-------------------+
```

### 2. Desglose de Componentes
1.  **Frontend (Cliente):**
    - **Stack:** React con Vite, TypeScript, Tailwind CSS.
    - **Funci√≥n:** Proporciona la interfaz de usuario (Dashboard) para que el cliente gestione su nodo. Se comunica con el Backend a trav√©s de una API RESTful.
    - **Despliegue:** Vercel (Front) / Ngrok Tunnel (Hybrid).
    - **Service Discovery:** `ngrokService` para autodetectar URLs p√∫blicas.
3.  **Backend (Servidor):**
    - **Stack:** Node.js con Express, TypeScript.
    - **Funci√≥n:** Es el n√∫cleo de la aplicaci√≥n. Gestiona la l√≥gica de negocio, la autenticaci√≥n (JWT), las peticiones de la API, y orquesta la comunicaci√≥n entre el Motor de WhatsApp, la Base de Datos y el Core de IA.
    - **Despliegue:** Local con Ngrok (H√≠brido) o Cloud (Render).
    - **Service Discovery:** `ngrokService` para autodetectar URLs p√∫blicas.
    - **Arquitectura:** Monolito Optimizado (Unified Core). Se prioriza la simplicidad operativa sobre la micro-segmentaci√≥n para la fase actual.
3.  **Motor de WhatsApp:**
    - **Librer√≠a:** `@whiskeysockets/baileys`.
    - **Funci√≥n:** Emula una sesi√≥n de WhatsApp Web, manteniendo una conexi√≥n WebSocket persistente con los servidores de WhatsApp. Se encarga de recibir y enviar mensajes en nombre del usuario. Cada cliente tiene su propia sesi√≥n aislada.
4.  **Base de Datos:**
    - **Servicio:** MongoDB Atlas.
    - **Funci√≥n:** Almacena toda la informaci√≥n persistente:
        - **Credenciales de Sesi√≥n (Baileys):** Permite reanudar sesiones de WhatsApp sin necesidad de escanear el QR constantemente.
        - **Datos de Usuario:** Perfiles, planes, configuraciones (`BotSettings`).
        - **Conversaciones:** Historial de mensajes, estado de leads, notas internas.
        - **Database Seeding:** Testimonios iniciales y datos de arranque inyectados desde el servidor para persistencia real.
5.  **Core de IA:**
    - **Servicio:** Google Gemini API (`@google/genai`).
    - **Funci√≥n:** Recibe el historial de una conversaci√≥n y las directivas del "Cerebro Neural" desde el Backend. Procesa el texto y devuelve una respuesta estructurada en JSON con el texto a enviar, el nuevo estado del lead, tags, etc.

### 3. Estado y Memoria (In-Memory Strategy)
Para garantizar la m√°xima velocidad de respuesta en "High Frequency Trading" (conversaciones r√°pidas), el sistema mantiene deliberadamente ciertos estados cr√≠ticos en memoria RAM (Volatile Memory):
- **Blacklists & Cooldowns:** Listas de bloqueo temporal de modelos de IA.
- **Campaign Locks:** Sem√°foros para evitar duplicaci√≥n de campa√±as.
- **QR Cache:** Im√°genes QR temporales.
**Nota T√©cnica:** Esta decisi√≥n arquitect√≥nica maximiza el throughput en arquitecturas de nodo √∫nico (Single-Tenant o Small-Cluster), pero requiere una estrategia de "Graceful Shutdown" para no perder estado en reinicios.

### 4. Flujo de Datos T√≠pico (Mensaje Entrante)
1.  **Recepci√≥n:** El Usuario Final env√≠a un mensaje a trav√©s de WhatsApp.
2.  **Ingesti√≥n:** El Motor de WhatsApp (`baileys`) recibe el mensaje a trav√©s de su WebSocket.
3.  **Procesamiento Inicial:** El motor identifica a qu√© cliente (`userId`) pertenece el mensaje y lo reenv√≠a al servicio de conversaciones del Backend.
4.  **Persistencia:** El `conversationService` guarda el mensaje entrante en la conversaci√≥n correspondiente en MongoDB.
5.  **Debounce y Calificaci√≥n:** Se activa un temporizador de 6 segundos. Si no llegan m√°s mensajes del mismo usuario en ese tiempo, se procede a la calificaci√≥n.
6.  **Llamada a IA:** El Backend construye un prompt con el historial de la conversaci√≥n y las configuraciones del cliente (`BotSettings`).
7.  **Inferencia:** Se env√≠a el prompt a la API de Google Gemini a trav√©s de la API Key del cliente (modelo BYOK).
8.  **Respuesta IA:** Gemini devuelve una respuesta JSON estructurada.
9.  **Acci√≥n:**
    - El Backend extrae el `responseText` y lo env√≠a al Motor de WhatsApp para que lo mande al Usuario Final.
    - El `newStatus` y los `tags` se actualizan en la base de datos para esa conversaci√≥n.
    - La respuesta del bot tambi√©n se guarda en el historial.
10. **Actualizaci√≥n UI (Delta Polling):** El Frontend utiliza un sistema de **Sincronizaci√≥n Incremental** (Cursor `?since=...`) consultando cada 2 segundos. El backend devuelve solo los cambios ocurridos despu√©s del √∫ltimo cursor, reduciendo el consumo de ancho de banda en un 95% para operaciones de alto volumen.

---

## üõ†Ô∏è STACK TECNOL√ìGICO Y ESTRUCTURA DE ARCHIVOS

### 1. Stack Tecnol√≥gico Principal
| √Årea              | Tecnolog√≠a Principal         | Descripci√≥n                                                              |
| ----------------- | ---------------------------- | ------------------------------------------------------------------------ |
| **Frontend**      | React (con Vite) & TypeScript| Para una UI moderna, r√°pida y tipada.                                    |
| **Estilos**       | Tailwind CSS                 | Framework Utility-First para un dise√±o r√°pido y consistente.             |
| **Backend**       | Node.js & Express            | Entorno de ejecuci√≥n y framework para construir la API RESTful.            |
| **Lenguaje (Back)** | TypeScript                 | A√±ade tipado est√°tico a JavaScript para robustez.                        |
| **Base de Datos**   | MongoDB (con Mongoose)     | Base de datos NoSQL flexible, ideal para los datos de sesi√≥n y chats.    |
| **Motor WhatsApp**| `@whiskeysockets/baileys`    | Librer√≠a clave que emula WhatsApp Web para la conexi√≥n.                  |
| **Inteligencia IA**| `@google/genai` (Gemini)     | SDK oficial para interactuar con los modelos de IA de Google.            |
| **Autenticaci√≥n** | JWT (jsonwebtoken)           | Est√°ndar para crear tokens de acceso seguros entre cliente y servidor.   |
| **Despliegue (BE)** | Ngrok / Render               | H√≠brido: Local con t√∫nel p√∫blico o Nube.                                 |
| **Despliegue (FE)** | Vercel                       | Plataforma optimizada para el despliegue de aplicaciones frontend.       |
| **Sincronizaci√≥n**  | Polling + Smart Link         | Estrategia robusta de actualizaci√≥n y reconexi√≥n autom√°tica.             |

### 2. Estructura de Archivos del Proyecto (`/src`)
```
/src
‚îú‚îÄ‚îÄ components/         # Componentes de React para la UI
‚îÇ   ‚îú‚îÄ‚îÄ Admin/          # Componentes espec√≠ficos del panel de Super Admin
‚îÇ   ‚îú‚îÄ‚îÄ Client/         # Componentes espec√≠ficos del cliente (TestBotSimulator)
‚îÇ   ‚îú‚îÄ‚îÄ AuthModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ ChatWindow.tsx
‚îÇ   ‚îú‚îÄ‚îÄ NetworkPanel.tsx       # [NUEVO] Panel de Red Colaborativa
‚îÇ   ‚îú‚îÄ‚îÄ NetworkConfigModal.tsx # [NUEVO] Modal de recuperaci√≥n de enlace (Smart Link)
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ controllers/        # L√≥gica de la API (manejo de requests/responses)
‚îÇ   ‚îú‚îÄ‚îÄ apiController.ts
‚îÇ   ‚îî‚îÄ‚îÄ adminController.ts
‚îú‚îÄ‚îÄ data/               # Datos est√°ticos (ej: textos legales)
‚îú‚îÄ‚îÄ middleware/         # Middlewares de Express (ej: autenticaci√≥n)
‚îú‚îÄ‚îÄ services/           # L√≥gica de negocio y comunicaci√≥n con APIs externas
‚îÇ   ‚îú‚îÄ‚îÄ aiService.ts      # L√≥gica de construcci√≥n de prompts y llamada a Gemini
‚îÇ   ‚îú‚îÄ‚îÄ radarService.ts   # Motor de detecci√≥n de oportunidades grupales (Radar 3.0)
‚îÇ   ‚îú‚îÄ‚îÄ ngrokService.ts   # [NUEVO] Servicio de autodeteci√≥n de t√∫neles
‚îÇ   ‚îú‚îÄ‚îÄ audioService.ts   # (Frontend) Gesti√≥n de reproducci√≥n de audio y TTS
‚îÇ   ‚îú‚îÄ‚îÄ conversationService.ts # Orquesta la l√≥gica de las conversaciones
‚îÇ   ‚îú‚îÄ‚îÄ logService.ts     # Sistema centralizado de logging
‚îÇ   ‚îú‚îÄ‚îÄ planService.ts    # Define las funcionalidades por tipo de plan
‚îÇ   ‚îú‚îÄ‚îÄ depthEngine.ts    # Motor de c√°lculo de profundidad cognitiva
‚îÇ   ‚îú‚îÄ‚îÄ capabilityResolver.ts # Resoluci√≥n de capacidades por usuario
‚îÇ   ‚îî‚îÄ‚îÄ ttsService.ts     # (Backend) Generaci√≥n de audio con Text-to-Speech
‚îú‚îÄ‚îÄ utils/              # Funciones de ayuda reutilizables
‚îú‚îÄ‚îÄ whatsapp/           # L√≥gica de conexi√≥n con WhatsApp (Baileys)
‚îÇ   ‚îú‚îÄ‚îÄ client.ts       # Orquesta la conexi√≥n, recepci√≥n y env√≠o de mensajes
‚îÇ   ‚îî‚îÄ‚îÄ mongoAuth.ts    # Almacena y recupera el estado de autenticaci√≥n de Baileys en MongoDB
‚îú‚îÄ‚îÄ App.tsx             # Componente ra√≠z de React
‚îú‚îÄ‚îÄ config.ts           # Configuraci√≥n compartida (URLs din√°micas)
‚îú‚îÄ‚îÄ database.ts         # Conexi√≥n con MongoDB y modelos de datos (Mongoose)
‚îú‚îÄ‚îÄ env.ts              # Carga y exporta variables de entorno
‚îú‚îÄ‚îÄ server.ts           # Punto de entrada del servidor Express
‚îî‚îÄ‚îÄ types.ts            # Definiciones de tipos y enumeraciones de TypeScript
```

---

## üìñ MANUALES OPERATIVOS

### 1. GU√çA PARA CLIENTES
Esta gu√≠a te ayudar√° a poner en marcha y operar tu nodo de Dominion.

#### a. Registro y Primeros Pasos
1.  **Solicitar Acceso:** En la p√°gina principal, haz clic en "Solicitar Acceso".
2.  **Completa el Formulario:**
    - **N√∫mero de WhatsApp:** Ser√° tu nombre de usuario. Ingresa el n√∫mero completo, incluyendo c√≥digo de pa√≠s (ej: 549261...).
    - **Nombre del Negocio:** El nombre que la IA usar√° para presentarse.
    - **Contrase√±a:** Elige una contrase√±a segura.
3.  **Acceso Inmediato:** Tras el registro, iniciar√°s sesi√≥n y comenzar√°s un per√≠odo de prueba **PRO** de 3 d√≠as o 10 leads calificados.
4.  **Guarda tu Master Recovery Key:** Se te mostrar√° una clave de recuperaci√≥n √∫nica. **¬°GU√ÅRDALA EN UN LUGAR SEGURO!** Es la √∫nica forma de recuperar tu cuenta si olvidas la contrase√±a.

#### b. Conexi√≥n del Nodo (Pesta√±a "Conexi√≥n")
1.  **Elige un M√©todo:**
    - **C√≥digo QR:** Abre WhatsApp en tu tel√©fono, ve a `Ajustes > Dispositivos Vinculados > Vincular un dispositivo` y escanea el QR que aparece en pantalla. Es el m√©todo m√°s r√°pido.
    - **Vincular Tel√©fono:** Ingresa tu n√∫mero de WhatsApp y haz clic en "Vincular". Recibir√°s una notificaci√≥n en tu tel√©fono para ingresar un c√≥digo de 8 caracteres que aparecer√° en Dominion.
2.  **Espera la Sincronizaci√≥n:** El estado cambiar√° a "Conectado" en unos segundos. ¬°Listo! Tu nodo est√° en l√≠nea.
3.  **Resetear Conexi√≥n:** Si tienes problemas para conectar, usa el bot√≥n "Limpiar rastro de sesi√≥n" o "Resetear Conexi√≥n" para forzar una desvinculaci√≥n completa y empezar de cero.

#### c. Configuraci√≥n del Cerebro Neural (Pesta√±a "Configuraci√≥n")
Esta es la parte m√°s importante. Aqu√≠ le ense√±as a la IA c√≥mo vender tu producto.

1.  **Carga una Plantilla (Opcional):** Para empezar r√°pido, selecciona una "Plantilla T√°ctica" que se ajuste a tu negocio (ej: Agencia, Inmobiliaria). Esto rellenar√° los campos principales.
2.  **Calibraci√≥n (Wizard de 3 Fases):**
    - **Fase 1 (Misi√≥n):** Define el nombre de tu negocio, tu misi√≥n principal y tu cliente ideal.
    - **Fase 2 (Arsenal):** Describe en detalle tu producto/servicio, el precio y el llamado a la acci√≥n (ej: un link para agendar una llamada).
    - **Fase 3 (Playbook):** Ense√±a a la IA a manejar objeciones comunes (ej: "¬øCu√°nto cuesta?") y establece las reglas que nunca debe romper.
3.  **Personalidad:** Ajusta el Tono, Ritmo e Intensidad de la IA para que coincida con la voz de tu marca.
4.  **API Key de Gemini:** Pega tu clave de la API de Google AI Studio en el campo correspondiente. Es **obligatorio** para que la IA funcione.
5.  **Sincronizar IA:** Siempre que hagas cambios, presiona el bot√≥n "Sincronizar IA" para que se apliquen.

### 2. GU√çA PARA SUPER ADMINISTRADOR
Esta gu√≠a cubre las funcionalidades del panel de control global.

#### a. Acceso
- **Credenciales:** Utiliza las credenciales de Super Administrador para iniciar sesi√≥n.
- **Vista por Defecto:** Al iniciar sesi√≥n, ser√°s dirigido directamente al "Panel de Control Global".

#### b. Visi√≥n General (Dashboard)
- **KPIs Globales:** Monitorea m√©tricas clave de toda la plataforma: MRR, total de clientes, nodos en l√≠nea, y cuentas en riesgo.
- **Distribuci√≥n de Planes:** Visualiza cu√°ntos clientes est√°n en cada plan (`pro` vs. `starter`).

#### c. Gesti√≥n de Clientes (Pesta√±a "Clientes")
- **Listado Completo:** Accede a una tabla con todos los clientes registrados.
- **Auditor√≠a ("Gestionar"):** Al hacer clic en "Gestionar" en un cliente, entras en el modo de auditor√≠a para cambiar datos y gestionar su plan.

---

## üõ°Ô∏è GOBERNANZA Y SEGURIDAD

### 1. Autenticaci√≥n y Autorizaci√≥n
- **Tokens JWT:** La comunicaci√≥n entre cliente y servidor est√° protegida mediante JSON Web Tokens.
- **Roles de Usuario:** El sistema implementa un control de acceso basado en roles (RBAC): `client` y `super_admin`.

### 2. Seguridad de Datos
- **Aislamiento de Datos (Multi-Tenant):** La arquitectura est√° dise√±ada para un aislamiento estricto de los datos de cada cliente.
- **Encriptaci√≥n de Contrase√±as:** Las contrase√±as se almacenan hasheadas con **bcrypt**.
- **Modelo BYOK (Bring Your Own Key):** La API Key de Gemini del cliente se almacena encriptada y se utiliza para todas las llamadas a la IA, minimizando el vector de ataque centralizado.

### 3. Seguridad de la Conexi√≥n de WhatsApp (Protocolo de Zona Roja)
- **Persistencia de Sesi√≥n Segura:** El estado de autenticaci√≥n de Baileys se almacena encriptado en MongoDB.
- **Mitigaci√≥n Activa de Riesgos:** La plataforma est√° dise√±ada para minimizar el riesgo de suspensi√≥n, pero operamos en **"Zona Roja"** (uso de API no oficial).
    - **Riesgo Inherente:** El cliente asume expl√≠citamente el riesgo de bloqueo del n√∫mero si abusa de las funciones de Campa√±a.
    - **Recomendaci√≥n de Onboarding:** Se sugiere usar n√∫meros secundarios o "madurados" para operaciones de alto volumen.
    - **Emulaci√≥n de Comportamiento Humano:** Se utiliza un sistema de 'debounce' (6s) para evitar respuestas instant√°neas y patrones detectables de bot.

### 4. Protocolos de Emergencia
- **Dead Man Switch (Backend):** Si el backend detecta una p√©rdida de control con el dashboard durante un periodo prolongado, entra en modo de conservaci√≥n, reduciendo el throughput.
- **Kill Switch Global:** El administrador puede activar un bloqueo total de campa√±as salientes desde el panel, deteniendo inmediatamente cualquier actividad riesgosa en todos los clientes.

---

## üé® DISE√ëO Y EXPERIENCIA DE USUARIO (UI/UX)

### 1. Filosof√≠a de Dise√±o: "Elite Neural Interface"
La interfaz debe sentirse como una herramienta profesional, precisa y de alta tecnolog√≠a, inspirada en terminales de datos y dashboards de inteligencia.

### 2. Paleta de Colores Principal
| Nombre                | Hex       | Rol en la UI                                                            |
| --------------------- | --------- | ----------------------------------------------------------------------- |
| `brand-black`         | `#050505` | Color de fondo principal.                                               |
| `brand-surface`       | `#121212` | Fondos para tarjetas y paneles.                                         |
| `brand-gold`          | `#D4AF37` | Color de acento principal para acciones y highlights.                   |

### 3. Tipograf√≠a
- **Fuente Principal:** `Inter` (sans-serif), por su alta legibilidad en interfaces densas.

---

## üîä SISTEMA DE AUDIO Y TEXT-TO-SPEECH (TTS)

### 1. Prop√≥sito
Proporcionar feedback auditivo para acciones de UI/UX y reforzar la identidad de marca "High-Tech".

### 2. Arquitectura
- **Backend (`ttsService.ts`):** Pre-genera archivos de audio para eventos (login, errores, conexiones) usando Gemini TTS y los sirve a trav√©s de un endpoint est√°tico.
- **Frontend (`audioService.ts`):** Gestiona la carga (con cach√©) y reproducci√≥n de los sonidos en el navegador usando la Web Audio API.

---

## üó∫Ô∏è ROADMAP EVOLUTIVO

### ‚úÖ v3.0 (Completado)
- **Persistencia Total (DB Seeding):** Eliminaci√≥n de localStorage.
- **Trigger Manual (Force Run):** Capacidad de forzar IA.
- **Infraestructura Robusta:** Polling optimizado y reconexi√≥n autom√°tica.
- **Audio Feedback:** Sistema TTS integrado.
- **Elite++ Training:** Simulador adversarial.
- **Motor de Campa√±as:** Sistema de difusi√≥n masiva.

### ‚úÖ v3.1.5 (Estado Actual - Blindado & Delta Sync)
- **Hard-Filter & Idempotencia:** Eliminaci√≥n de duplicados y mensajes de lista negra en el borde.
- **Delta Polling:** Sincronizaci√≥n incremental para alto rendimiento con +100 clientes.
- **Watchdog de CPU:** Protecci√≥n contra sobrecarga del servidor en arquitecturas monje-n√∫cleo.
- **Red Dominion:** Intercambio colaborativo de leads.
- **Protocolo Smart Link:** Autorecuperaci√≥n de conexi√≥n backend.

### üöß v3.2 (Hardening Phase - Pr√≥ximo)
- **Migraci√≥n de Estado Vol√°til:** Mover `processingCampaignIds` y `modelCooldowns` de memoria RAM a una capa persistente r√°pida (Redis/Mongo TTL) para escalar horizontalmente.
- **Optimizaci√≥n de Carga Frontend:** Implementar polling adaptativo para reducir la carga en MongoDB cuando hay inactividad.
- **Refuerzo de Baileys:** Implementar estrategia de "Session Restoration" avanzada para minimizar desconexiones inesperadas.

### üåå Visi√≥n a Largo Plazo
- **Integraci√≥n Multi-Canal:** Expandir el motor a Instagram DMs, Telegram, etc.
- **Inteligencia de Negocio Aut√≥noma:** Permitir que la IA analice las m√©tricas y sugiera mejoras en la configuraci√≥n del "Cerebro Neural" basadas en el an√°lisis de m√©tricas.

---

## ‚öñÔ∏è ASPECTOS LEGALES Y FILOSOF√çA OPERATIVA

### 1. POL√çTICA DE PRIVACIDAD
- **Modelo BYOK:** Dominion Bot act√∫a como un orquestador t√©cnico. La IA es provista por Google a trav√©s de tu propia API Key. **No entrenamos modelos con tus datos.**
- **Aislamiento:** Cada cuenta opera en un entorno de datos l√≥gicamente separado.

### 2. T√âRMINOS Y CONDICIONES
- **Pol√≠tica Anti-Spam:** El uso para env√≠o masivo de mensajes no solicitados est√° estrictamente prohibido.
- **Riesgos de WhatsApp:** Se utiliza un protocolo no oficial. Si bien la arquitectura mitiga activamente los riesgos, el usuario asume la responsabilidad inherente de un posible bloqueo num√©rico por parte de WhatsApp. Dominion Bot NO se hace responsable por la p√©rdida de n√∫meros.

### 3. MANIFIESTO DOMINION
- **Human in the Loop:** El Bot califica, el Humano cierra.
- **Calidad sobre Cantidad:** Optimizado para ventas de alto valor y consultivas.
- **Tecnolog√≠a con Prop√≥sito:** Cada feature existe para vender m√°s, sin relleno.
- **Usuarios Calificados (Power Users):** El sistema requiere un operador consciente. Un mal prompt o un uso abusivo de campa√±as romper√° la reputaci√≥n de la l√≠nea. Se requiere entrenamiento o "gatekeeping" en el acceso.

---

## ‚ö° ADDENDUM v3.0: CAPACIDADES T√ÅCTICAS Y CAMBIOS ESTRUCTURALES

### 1. Protocolo de Trial Din√°mico (Gobernanza de Escasez)
Para maximizar la conversi√≥n del usuario SaaS, hemos endurecido las reglas del per√≠odo de prueba. Ya no es solo tiempo, es **resultado**.
- **L√≠mite H√≠brido:** El trial finaliza a los **7 d√≠as** O al calificar los primeros **10 Leads**, lo que ocurra primero.
- **Psicolog√≠a:** Esto fuerza al usuario a valorar cada interacci√≥n de la IA. Si la IA le consigue 10 clientes potenciales, el valor est√° demostrado y el bloqueo se activa, obligando a la compra para continuar operando.

### 2. Ingesta Multimedia (Ojos y O√≠dos del Sistema)
El motor de WhatsApp (`client.ts`) reconoce tipos de mensajes no textuales en el historial.
- **Capacidad:** El sistema ahora detecta `[Imagen]`, `[Audio]`, `[Video]`, `[Ubicaci√≥n]`.
- **Utilidad:** Esto evita que el historial se rompa o se ignore si el √∫ltimo mensaje del cliente fue una foto (muy com√∫n en talleres, inmobiliarias, etc.). Aunque la IA procesa texto, ahora tiene conciencia de que "algo m√°s" fue enviado.

### 3. Simulador Neural Elite++ (Training Lab)
Se ha evolucionado el entorno de pruebas (`TestBotSimulator.tsx`).
- **Funci√≥n:** Permite someter al bot a escenarios de estr√©s (precios, confusi√≥n, competencia).
- **Inteligencia:** Incluye un evaluador pasivo que detecta patrones de fallo y asigna un score de robustez.

### 4. Trigger Manual de Inferencia (Bot√≥n de P√°nico)
Se ha a√±adido un control de anulaci√≥n manual en la interfaz de chat (`ChatWindow`).
- **Problema:** A veces el *debounce* (espera autom√°tica) es muy lento para un vendedor ansioso, o el socket de WhatsApp se retrasa.
- **Soluci√≥n:** Un bot√≥n **"EJECUTAR IA"** que fuerza una llamada inmediata a Gemini, ignorando los temporizadores de espera y el estado de silencio, permitiendo una intervenci√≥n t√°ctica instant√°nea.

### 5. Persistencia de la Verdad (Database Seeding)
Se ha eliminado cualquier dependencia de `localStorage` para simular datos en la Landing Page o Dashboard.
- **Implementaci√≥n:** El servidor (`server.ts` y `database.ts`) verifica al inicio si la base de datos est√° vac√≠a. Si lo est√°, inyecta ("siembra") testimonios y datos iniciales directamente en MongoDB con fechas pre-calculadas.
- **Resultado:** Los datos son consistentes a trav√©s de dispositivos y resistentes al borrado de cach√© del navegador. Lo que el usuario ve es real desde la perspectiva de la aplicaci√≥n.

### 6. Motor de Campa√±as (Broadcast T√°ctico)
Implementado en `campaignService.ts`, permite la programaci√≥n y env√≠o de mensajes a grupos.
- **Anti-Ban Jitter:** Retrasos aleatorios entre mensajes (configurables) para imitar comportamiento humano.
- **Memory Lock (Sem√°foro):** Sistema de bloqueo en memoria RAM que impide condiciones de carrera (Race Conditions), asegurando que una campa√±a nunca se ejecute por duplicado, incluso si el scheduler se solapa por latencia de red.
- **Circuit Breaker:** Si una campa√±a falla 3 veces consecutivamente (errores l√≥gicos, no de red), se aborta autom√°ticamente para proteger la reputaci√≥n de la cuenta.
- **Gobernador de Tr√°fico Global:** El sistema limita el n√∫mero de campa√±as concurrentes en toda la plataforma (ej: 2 a la vez) para no saturar la IP y evitar bloqueos.
- **Watchdog de Hardware (Event Loop Guard):** El motor monitorea la carga de la CPU. Si detecta un "lag" excesivo, pausa el env√≠o de campa√±as para permitir que el hardware se recupere, priorizando la estabilidad.
- **Inmunidad a Fallos de Red:** Errores de conexi√≥n a internet (ISP local) no cuentan como fallos de campa√±a, evitando que el Circuit Breaker se active por problemas externos.

### 7. Ejecuci√≥n Forzada de Campa√±as (Override)
Se ha implementado un control manual ("Rayo" ‚ö°) en el panel de campa√±as.
- **Funci√≥n:** Permite disparar una campa√±a inmediatamente, ignorando la hora programada y la ventana operativa de seguridad.
- **Uso:** Ideal para pruebas r√°pidas o comunicaciones de emergencia que no pueden esperar al ciclo del scheduler.

---

## üîó ADDENDUM v3.1: PROTOCOLOS DE SUPERVIVENCIA (SMART LINK)

### 1. Tunnel Heartbeat (Latido del T√∫nel)
El frontend ya no es ciego. Implementa un sistema de monitoreo activo (`App.tsx`) que verifica la salud de la conexi√≥n con el backend cada 5 segundos.
- **Diagn√≥stico en Tiempo Real:** Mide la latencia y la muestra en la cabecera.
    - **Verde (<300ms):** √ìptimo.
    - **Amarillo (<1000ms):** Lag detectado (posible congesti√≥n).
    - **Rojo (>1000ms o Error):** Falla de conexi√≥n.
- **L√≥gica de Fallo:** Si el heartbeat falla 3 veces consecutivamente, el sistema asume que la URL del t√∫nel (Ngrok) ha cambiado o ca√≠do.

### 2. Protocolo Smart Link (Autorecuperaci√≥n)
Para combatir la volatilidad de las URLs p√∫blicas en entornos h√≠bridos/locales:
- **Backend Autoconsciente:** El servicio `ngrokService.ts` consulta la API local de Ngrok para descubrir su propia URL p√∫blica al inicio.
- **Frontend Din√°mico:** Si se detecta una desconexi√≥n sostenida, la UI despliega autom√°ticamente el **Modal de Enlace Satelital**.
- **Recuperaci√≥n sin C√≥digo:** El usuario puede ingresar la nueva URL (visible en la consola del servidor) directamente en la interfaz. Esta se guarda en `localStorage` y el sistema se reconecta instant√°neamente sin necesidad de un redeploy.

### 3. Watchdog de Hardware
El `campaignService.ts` implementa un monitor de "Lag de Event Loop".
- **Funci√≥n:** Detecta si la CPU del servidor est√° saturada midiendo la deriva temporal entre ticks del reloj.
- **Acci√≥n:** Si el retraso supera los 200ms, el sistema pausa el procesamiento de campa√±as durante un ciclo para permitir que el hardware se recupere, priorizando la estabilidad sobre la velocidad.

---

## üõ°Ô∏è ADDENDUM v3.1.2: RESILIENCIA COGNITIVA (FALLBACK MATRIX)

### 1. Arquitectura de Supervivencia (5-Tier Fallback)
Para garantizar una disponibilidad del 99.9% incluso durante ca√≠das de Google Cloud, hemos implementado una **Matriz de Derivaci√≥n Secuencial** de 5 niveles.
- **Filosof√≠a:** En un chatbot de ventas, la latencia es secundaria; la disponibilidad de la respuesta es absoluta.
- **Secuencia de Disparo:**
    1.  `gemini-2.0-flash-exp` (Velocidad Experimental)
    2.  `gemini-2.5-flash` (Est√°ndar de Producci√≥n)
    3.  `gemini-3-flash-preview` (Nueva Generaci√≥n)
    4.  `gemini-2.5-pro` (Razonamiento Profundo)
    5.  `gemini-3-pro-preview` (√öltimo Recurso / M√°xima Potencia)

### 2. Sistema de Lista Negra Temporal (Cooldown Autom√°tico)
Para evitar bucles de latencia infinita intentando consultar modelos ca√≠dos o agotados:
- **Mecanismo:** Si un modelo falla (Error 5xx/429), el sistema lo ingresa autom√°ticamente en una **Lista Negra en Memoria**.
- **Penalizaci√≥n:** El modelo bloqueado es ignorado por el enrutador durante **60 minutos**.
- **Resultado:** El sistema aprende qu√© "neuronas" est√°n da√±adas y las evita instant√°neamente, redirigiendo el tr√°fico a nodos sanos sin que el usuario perciba el error.

---

## ‚öîÔ∏è ADDENDUM v3.1.5: BLINDAJE ESTRUCTURAL & DELTA SYNC (QUIR√öRGICO)

### 1. Hard-Filter de Ingesta (Muralla Perimetral)
Implementado directamente en el evento `messages.upsert` de Baileys (`client.ts`).
- **Funci√≥n:** Antes de que un mensaje toque la base de datos o consuma ciclos de CPU, se verifica si el remitente est√° en la `ignoredJids` (Lista Negra).
- **Efecto:** Los mensajes de n√∫meros bloqueados son descartados instant√°neamente (`continue`), protegiendo al sistema de ataques de spam o saturaci√≥n.

### 2. Idempotencia de Mensajes (No-Duplication)
Baileys a veces reenv√≠a mensajes por latencia de red. El `conversationService.ts` ahora implementa un chequeo estricto.
- **L√≥gica:** Antes de hacer `push` de un mensaje al array, se verifica si el `message.id` ya existe en el historial local.
- **Resultado:** Integridad absoluta del historial. Cero mensajes duplicados, cero respuestas dobles de la IA.

### 3. Delta Polling / Since-Cursor (Escalabilidad Masiva)
El sistema ha abandonado el polling de "Estado Completo" para adoptar una sincronizaci√≥n incremental.
- **Mecanismo:** El cliente env√≠a `?since=TIMESTAMP` al endpoint `/api/conversations`.
- **Optimizaci√≥n:** El servidor solo devuelve las conversaciones que han tenido actividad (`lastActivity`) posterior a esa marca de tiempo.
- **Impacto:** Reduce la carga de transferencia de datos en un 95% para cuentas con historiales grandes, permitiendo escalar a +100 clientes en una sola instancia.

### 4. Protocolo "Human Touch" (Degradaci√≥n T√°ctica)
Para resolver la fricci√≥n entre la IA y la intervenci√≥n humana.
- **Detecci√≥n:** Si el due√±o responde manualmente (`sender === 'owner'`), el sistema inyecta el tag `HUMAN_TOUCH`.
- **Degradaci√≥n:** Si el estado era `HOT`, se degrada autom√°ticamente a `WARM`.
- **Efecto:** La IA sale del "Shadow Mode" (silencio total) y vuelve a un modo de asistencia activa, priorizando soporte t√©cnico en lugar de intentar cerrar la venta por encima del humano.
